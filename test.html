<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>線上測驗系統</title>

<style>
body{
  font-family:"Noto Sans TC",Arial,sans-serif;
  background:#f6f7f9;
  margin:0;
  padding:32px;
}
.container{max-width:960px;margin:auto}
.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:14px;
  padding:24px;
}
h1,h2{margin:0 0 16px}
.meta{display:flex;gap:12px;flex-wrap:wrap;font-size:14px}
.badge{
  border:1px solid #ccc;
  border-radius:999px;
  padding:4px 12px;
}
.opt{
  border:1px solid #ddd;
  border-radius:10px;
  padding:12px;
  margin:10px 0;
  cursor:pointer;
}
.opt:hover{background:#f2f7ff}
.opt.correct{background:#e8f7ec;border-color:#4caf50}
.opt.wrong{background:#fdeaea;border-color:#f44336}
textarea{
  width:100%;
  min-height:160px;
  font-family:Consolas,monospace;
  font-size:14px;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  resize:vertical;
  box-sizing:border-box;
}
button{
  padding:10px 16px;
  border-radius:8px;
  border:1px solid #888;
  background:#fff;
  cursor:pointer;
}
button.primary{
  background:#2b7cff;
  color:#fff;
  border-color:#2b7cff;
}
.footer{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap}
.list li{cursor:pointer;color:#0066cc;margin:6px 0}
.list li:hover{text-decoration:underline}
.center{text-align:center}
</style>
</head>

<body>
<div class="container">

<!-- ===== 設定頁 ===== -->
<div id="setupPage" class="card">
  <h1>測驗設定</h1>
  <label>
    <input type="checkbox" id="shuffleOpt" checked>
    題目亂數出題
  </label>
  <div class="footer">
    <button class="primary" onclick="startQuiz()">開始測驗</button>
  </div>
</div>

<!-- ===== 測驗頁 ===== -->
<div id="quizPage" class="card" style="display:none">
  <div class="meta">
    <span class="badge" id="progress"></span>
    <span class="badge" id="score"></span>
  </div>

  <h2 id="qText"></h2>
  <div id="qBody"></div>

  <div class="footer">
    <button onclick="prevQ()">上一題</button>
    <button onclick="nextQ()">下一題</button>
    <button onclick="submitExam()">送出測驗</button>
    <button id="backToResultBtn" onclick="backToResult()" style="display:none">
      回成績頁
    </button>
  </div>
</div>

<!-- ===== 成績頁 ===== -->
<div id="resultPage" class="card" style="display:none">
  <h1 class="center">測驗結果</h1>
  <div class="meta center">
    <span class="badge" id="rTotal"></span>
    <span class="badge" id="rCorrect"></span>
    <span class="badge" id="rRate"></span>
  </div>

  <h2>錯題 / 未作答</h2>
  <ul id="wrongList" class="list"></ul>

  <div class="footer center">
    <button onclick="location.reload()">重新開始</button>
  </div>
</div>

</div>

<script>
/* ===== 題庫 ===== */
let BANK=[];
fetch("./format.txt")
  .then(r=>r.json())
  .then(d=>BANK=d);

/* ===== 狀態 ===== */
let order=[],pos=0,correct=0;
let isReviewMode=false;
const answered=new Set();
const userAns=new Map();

/* ===== 工具 ===== */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function ansIdx(q){return q.answer?.charCodeAt(0)-65}

/* ===== 開始 ===== */
function startQuiz(){
  order=[...BANK.keys()];
  if(shuffleOpt.checked) shuffle(order);

  pos=0;
  correct=0;
  answered.clear();
  userAns.clear();
  isReviewMode=false;

  setupPage.style.display="none";
  resultPage.style.display="none";
  quizPage.style.display="block";
  render();
}

/* ===== Render ===== */
function render(){
  const qIdx=order[pos];
  const q=BANK[qIdx];

  progress.textContent=`題目 ${pos+1}/${order.length}`;
  score.textContent=`答對 ${correct}`;
  qText.textContent=q.q;
  qBody.innerHTML="";

  backToResultBtn.style.display=isReviewMode?"inline-block":"none";

  if(q.options){
    q.options.forEach((opt,i)=>{
      const d=document.createElement("div");
      d.className="opt";
      d.textContent=`${String.fromCharCode(65+i)}. ${opt}`;

      if(answered.has(qIdx)){
        const c=ansIdx(q);
        if(userAns.get(qIdx)===i){
          d.classList.add(i===c?"correct":"wrong");
        }
        if(i===c) d.classList.add("correct");
      }

      d.onclick=()=>{
        if(answered.has(qIdx) || isReviewMode) return;
        userAns.set(qIdx,i);
        answered.add(qIdx);
        if(i===ansIdx(q)) correct++;
        setTimeout(nextQ,300);
      };
      qBody.appendChild(d);
    });
  }else{
    const ta=document.createElement("textarea");
    ta.placeholder="請輸入你的答案或程式碼";
    if(userAns.has(qIdx)) ta.value=userAns.get(qIdx);
    ta.oninput=()=>userAns.set(qIdx,ta.value);
    qBody.appendChild(ta);
  }
}

/* ===== 控制 ===== */
function nextQ(){
  if(isReviewMode){
    if(pos<order.length-1){pos++;render();}
    return;
  }
  if(pos<order.length-1){pos++;render();}
  else submitExam();
}
function prevQ(){if(pos>0){pos--;render();}}

function submitExam(){
  quizPage.style.display="none";
  resultPage.style.display="block";
  isReviewMode=false;

  rTotal.textContent=`總題數 ${order.length}`;
  rCorrect.textContent=`答對 ${correct}`;
  rRate.textContent=`正確率 ${Math.round(correct/order.length*100)}%`;

  wrongList.innerHTML="";
  order.forEach((qIdx,i)=>{
    if(!answered.has(qIdx) || userAns.get(qIdx)!==ansIdx(BANK[qIdx])){
      const li=document.createElement("li");
      li.textContent=`第 ${i+1} 題：${BANK[qIdx].q}`;
      li.onclick=()=>{
        isReviewMode=true;
        resultPage.style.display="none";
        quizPage.style.display="block";
        pos=i;
        render();
      };
      wrongList.appendChild(li);
    }
  });
}

function backToResult(){
  isReviewMode=false;
  quizPage.style.display="none";
  resultPage.style.display="block";
}
</script>

</body>
</html>
